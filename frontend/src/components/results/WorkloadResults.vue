<!--
  @fileoverview WorkloadResults component that displays benchmark results, workload plots, execution plans, and index information.
  @component WorkloadResults
  @author Eva Ray
  @description This component aggregates and displays the results of a workload benchmark, including execution times,
  execution plans, and index information. It uses child components to render the results in a structured format.
  The style has been generated by an LLM.
 -->

<script setup>
import { computed } from 'vue'
import WorkloadPlot from './WorkloadPlot.vue'
import WorkloadPlan from './WorkloadPlan.vue'
import BenchmarkResultsTable from './BenchmarkResultsTable.vue'
import IndexInfoTable from './IndexInfoTable.vue'

const props = defineProps({
  results: {
    type: Object,
    default: () => ({})
  }
})

/**
 *  This function processes the results object, which may contain multiple databases and queries, and flattens it into
 *  a single array of objects for easier rendering in the table.
 */
const flattenedResults = computed(() => {
  const flattened = []

  Object.entries(props.results).forEach(([dbName, dbData]) => {
    // Check if the data follows the new format with results property
    if (dbData.results) {
      // Process query results
      Object.entries(dbData.results).forEach(([queryName, metrics]) => {
        flattened.push({
          dbName,
          queryName,
          query: metrics.query || '',
          avgExecutionTime: metrics.avgExecutionTime,
          queryPerSecond: metrics.queryPerSecond,
          explainPlan: metrics.explainPlan,
          initialConnectionTime: metrics.initialConnectionTime,
          standardDeviation: metrics.standardDeviation,
          variance: metrics.variance,
          percentile95: metrics.percentile95,
          cacheHitsRatio: metrics.cacheInfo?.hitsRatio || 0,
          cacheHits: metrics.cacheInfo?.hits || 0,
          cacheMisses: metrics.cacheInfo?.misses || 0
        })
      })
    } else {
      // Handle old format for backward compatibility
      Object.entries(dbData).forEach(([queryName, metrics]) => {
        flattened.push({
          dbName,
          queryName,
          avgExecutionTime: metrics.avgExecutionTime,
          queryPerSecond: metrics.queryPerSecond,
          explainPlan: metrics.explainPlan
        })
      })
    }
  })

  return flattened.sort((a, b) => a.queryName.localeCompare(b.queryName))
})

/**
 * Computes the chart data for rendering workload plots.
 * This function maps the flattened results to a format suitable for the WorkloadPlot component.
 */
const chartData = computed(() => {
  return flattenedResults.value.map(result => ({
    dbName: result.dbName,
    queryName: result.queryName,
    avgExecutionTime: result.avgExecutionTime || 0,
    percentile95: result.percentile95 || 0,
    cacheHitsRatio: result.cacheHitsRatio || 0
  }))
})

/**
 * Computes the execution plans for rendering in the WorkloadPlan component.
 * This function extracts the execution plan and query name from the flattened results.
 */
const executionPlans = computed(() => {
  return flattenedResults.value.map(result => ({
    dbName: result.dbName,
    explainPlan: result.explainPlan || "No execution plan available",
    queryName: result.queryName,
    query: result.query || ""
  }))
})

/**
 * Extracts index information from the results.
 * This function processes the index information for each database and query, returning a structured array.
 */
const indexInfo = computed(() => {
  const indexData = []

  Object.entries(props.results).forEach(([dbName, dbData]) => {
    if (dbData.indexInfo && Array.isArray(dbData.indexInfo)) {
      dbData.indexInfo.forEach(index => {
        indexData.push({
          dbName,
          ...index
        })
      })
    }
  })

  return indexData
})
</script>

<template>
  <div v-if="results && Object.keys(results).length > 0" class="results-container">
    <h2 class="results-title">Benchmark Results</h2>
    <BenchmarkResultsTable :results="flattenedResults" />
    <WorkloadPlot :chartData="chartData" />
    <WorkloadPlan :executionPlans="executionPlans" />
    <IndexInfoTable v-if="indexInfo.length > 0" :indexInfo="indexInfo" />
  </div>
</template>

<style scoped>
.results-container {
  background: #f6f7fb;
  max-width: 100%;
  margin: 40px auto;
  padding: 32px 24px;
  border-radius: 20px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05), 0 1.5px 4px rgba(0, 0, 0, 0.03);
  font-family: 'Inter', 'Segoe UI', Arial, sans-serif;
}

.results-title {
  color: #23272f;
  font-size: 2rem;
  font-weight: 600;
  margin-bottom: 32px;
  text-align: center;
  letter-spacing: 0.01em;
}

@media (max-width: 768px) {
  .results-container {
    padding: 16px 4px;
  }
}
</style>