<!--
  @fileoverview ConfigSelection component that allows users to select a benchmark configuration file and type.
  @component ConfigSelection
  @author Eva Ray
  @description This component provides a drag-and-drop interface for users to upload a benchmark configuration JSON file,
  select a benchmark type, and view the selected endpoint. It emits events when the configuration is loaded and when an
  endpoint is selected. It also provides a method to expose the selections to parent components.
  The style has been generated by an LLM.
-->
<script setup>
import { ref } from 'vue'
import BenchmarkTypeSelection from './BenchmarkTypeSelection.vue'

const emit = defineEmits(['config-loaded', 'endpoint-selected'])

const isDragging = ref(false)
const errorMessage = ref('')
const successMessage = ref('')
const selectedEndpoint = ref('')
const loadedConfig = ref(null)
const configFilename = ref('')
const benchmarkTypeRef = ref(null)

/**
 * Handles the selection of a benchmark type.
 * @param typeObj The selected benchmark type object containing the endpoint.
 */
const handleTypeSelected = (typeObj) => {
  selectedEndpoint.value = typeObj.endpoint
  emit('endpoint-selected', typeObj)
}

/**
 * Exposes the current selections including the loaded configuration,
 * the selected endpoint, and the configuration filename.
 */
const getSelections = () => {
  return {
    config: loadedConfig.value,
    endpoint: benchmarkTypeRef.value.getSelections().endpoint,
    filename: configFilename.value
  }
}

// Expose the getSelections method to parent components
defineExpose({
  getSelections
})

// Drag and drop event handlers
const handleDragEnter = (e) => {
  e.preventDefault()
  e.stopPropagation()
  isDragging.value = true
}

const handleDragLeave = (e) => {
  e.preventDefault()
  e.stopPropagation()
  isDragging.value = false
}

const handleDragOver = (e) => {
  e.preventDefault()
  e.stopPropagation()
  isDragging.value = true
}

/**
 * Validates if the dropped file is a valid JSON file.
 * @param {File} file The file to validate.
 * @returns {boolean} True if the file is a valid JSON file, false otherwise.
 */
const validateJsonFile = (file) => {
  // Check file type
  if (!file.type && file.name.endsWith('.json')) {
    return true // Some browsers don't provide type for JSON files
  }
  return file.type === 'application/json' || file.name.endsWith('.json')
}

/**
 * Handles the drop event for the drag-and-drop area.
 * Reads the dropped file, validates it, and emits the loaded configuration.
 * @param {DragEvent} e The drop event.
 */
const handleDrop = (e) => {
  e.preventDefault()
  e.stopPropagation()
  isDragging.value = false
  errorMessage.value = ''
  successMessage.value = ''
  
  // Get the dropped file
  const files = e.dataTransfer.files
  if (files.length > 0) {
    const file = files[0]
    
    // Validate file type
    if (!validateJsonFile(file)) {
      errorMessage.value = 'Please drop a valid JSON file'
      return
    }
    
    // Read the file
    const reader = new FileReader()
    reader.onload = (event) => {
      try {
        const config = JSON.parse(event.target.result)
        successMessage.value = `Loaded configuration from ${file.name}`
        // Store the config and filename
        loadedConfig.value = config
        configFilename.value = file.name
        emit('config-loaded', {
          config,
          endpoint: selectedEndpoint.value,
          filename: file.name
        })
      } catch (error) {
        errorMessage.value = 'Invalid JSON format. Please check your file.'
        console.error('Error parsing JSON:', error)
      }
    }
    reader.onerror = () => {
      errorMessage.value = 'Error reading the file'
    }
    reader.readAsText(file)
  }
}

/**
 * Handles the change event for the file input.
 * Validates the selected file and reads its content.
 * @param {Event} e The change event from the file input.
 */
const handleFileInputChange = (e) => {
  errorMessage.value = ''
  successMessage.value = ''
  
  const file = e.target.files[0]
  if (!file) return
  
  // Validate file type
  if (!validateJsonFile(file)) {
    errorMessage.value = 'Please select a valid JSON file'
    return
  }
  
  // Read the file
  const reader = new FileReader()
  reader.onload = (event) => {      try {
      const config = JSON.parse(event.target.result)
      successMessage.value = `Loaded configuration from ${file.name}`
      // Store the config and filename
      loadedConfig.value = config
      configFilename.value = file.name
      emit('config-loaded', {
        config,
        endpoint: selectedEndpoint.value,
        filename: file.name
      })
    } catch (error) {
      errorMessage.value = 'Invalid JSON format. Please check your file.'
      console.error('Error parsing JSON:', error)
    }
  }
  reader.onerror = () => {
    errorMessage.value = 'Error reading the file'
  }
  reader.readAsText(file)
}
</script>

<template>
  <div class="config-selection">
    <!-- Benchmark Type Selection -->
    <BenchmarkTypeSelection @type-selected="handleTypeSelected" ref="benchmarkTypeRef"/>
    
    <h3>Benchmark Configuration</h3>
    
    <!-- Drag and Drop Area -->
    <div
      class="dropzone"
      :class="{ 'active': isDragging }"
      @dragenter="handleDragEnter"
      @dragleave="handleDragLeave"
      @dragover="handleDragOver"
      @drop="handleDrop"
    >
      <div class="dropzone-content">
        <div class="icon">üìÑ</div>
        <p>Drag and drop your benchmark configuration JSON file here</p>
        <p class="or-divider">OR</p>
        <label class="btn">
          Browse Files
          <input 
            type="file" 
            accept=".json,application/json" 
            class="file-input" 
            @change="handleFileInputChange"
          />
        </label>
      </div>
    </div>
    
    <!-- Messages -->
    <div v-if="errorMessage" class="error">
      <span>‚ùå {{ errorMessage }}</span>
    </div>
    <div v-if="successMessage" class="success">
      <span>‚úÖ {{ successMessage }}</span>
    </div>
    
    <!-- Help Text -->
    <div class="help-text">
      <p>The configuration file should be a valid JSON file containing your benchmark settings.</p>
      <p v-if="selectedEndpoint" class="endpoint-info">
        Selected endpoint: <code>{{ selectedEndpoint }}</code>
      </p>
    </div>
  </div>
</template>

<style>
.config-selection {
  padding: 20px;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
}

.dropzone {
  border: 2px dashed #ccc;
  border-radius: 12px;
  padding: 40px 20px;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s ease;
  background-color: #f8f9fa;
  margin-bottom: 20px;
}

.dropzone.active {
  border-color: #007bff;
  background-color: rgba(0, 123, 255, 0.05);
}

.dropzone-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.icon {
  font-size: 2.5rem;
  margin-bottom: 8px;
}

.or-divider {
  position: relative;
  margin: 10px 0;
  font-size: 0.9rem;
  color: #777;
}

.file-input {
  display: none;
}

.help-text {
  font-size: 0.9rem;
  color: #6c757d;
  margin-top: 20px;
}

.endpoint-info {
  margin-top: 10px;
  font-weight: 500;
}

.endpoint-info code {
  background-color: #f1f3f5;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: monospace;
  color: #007bff;
}
</style>