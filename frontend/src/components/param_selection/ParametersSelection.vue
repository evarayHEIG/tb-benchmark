<!--
  @fileoverview ParametersSelection component that allows users to select parameters for benchmarking.
  @component ParametersSelection
  @author Eva Ray
  @description This component provides a user interface for selecting benchmark parameters such as query type,
  database selection, and workload. It emits the results when the benchmark is ready.
  The style has been generated by an LLM.
-->

<script setup>
import { ref, computed, provide } from 'vue'
import QuerySelection from './QuerySelection.vue'
import DbSelection from './DbSelection.vue'
import DbSizeSelection from './DbSizeSelection.vue'
import BenchTypeButton from './BenchTypeButton.vue'
import WorkloadSelection from './WorkloadSelection.vue'
import ConfigSelection from './ConfigSelection.vue'

// Define emits
const emit = defineEmits(['results-ready'])

// Template refs to access child components
const querySelectionRef = ref(null)
const dbSelectionRef = ref(null)
const dbSizeSelectionRef = ref(null)
const benchTypeButtonRef = ref(null)
const workloadSelectionRef = ref(null)
const configSelectionRef = ref(null)

// State for benchmark results
const benchmarkResults = ref(null)
const isLoading = ref(false)
const apiError = ref(null)

// API endpoints
const API_BASE_URL = 'http://localhost:7070'
const ENDPOINTS = {
  UNIQUE: '/benchmark/unique',
  WORKLOAD: '/benchmark/workload'
}

// Provide shared state to child components
provide('isLoading', isLoading)

const currentBenchType = computed(() => {
  try {
    return benchTypeButtonRef.value?.getSelections()?.benchType || 'UNIQUE'
  } catch (error) {
    return 'UNIQUE' // Default value
  }
})

/**
 * Computed property to check if there are empty fields in the form.
 * @type {ComputedRef<boolean|boolean|undefined>}
 */
const hasEmptyFields = computed(() => {
  if (!benchTypeButtonRef.value) {
    return true
  }

  const benchTypeData = benchTypeButtonRef.value.getSelections()

  if (benchTypeData.benchType === 'CONFIG') {
    // Pour CONFIG: valider la sélection de configuration
    if (!configSelectionRef.value) return true
    const configData = configSelectionRef.value.getSelections()
    const isConfigEmpty = !configData.config || Object.keys(configData.config).length === 0
    return isConfigEmpty
  }

  if (!dbSelectionRef.value || !dbSizeSelectionRef.value) {
    return true
  }

  try {
    const dbData = dbSelectionRef.value.getSelections()
    const sizeData = dbSizeSelectionRef.value.getSelections()

    // Validations communes pour les deux types
    const isDbEmpty = !dbData.selectedDatabases || dbData.selectedDatabases.length === 0
    const isSizeEmpty = !sizeData.selectedSize || sizeData.selectedSize === ''
    const isBenchTypeEmpty = !benchTypeData.benchType || benchTypeData.benchType === ''

    // Retourner rapidement si les champs communs sont vides
    if (isDbEmpty || isSizeEmpty || isBenchTypeEmpty) {
      return true
    }

    // Validations spécifiques basées sur le type de benchmark
    if (benchTypeData.benchType === 'UNIQUE') {
      // Pour UNIQUE: valider la sélection de requête
      if (!querySelectionRef.value) return true
      const queryData = querySelectionRef.value.getSelections()
      const isQueryEmpty = !queryData.selectedQuery || queryData.selectedQuery === ''
      const isExecutionsEmpty = !queryData.numberOfExecutions || queryData.numberOfExecutions <= 0
      return isQueryEmpty || isExecutionsEmpty

    } else if (benchTypeData.benchType === 'WORKLOAD') {
      // Pour WORKLOAD: valider la sélection de workload
      if (!workloadSelectionRef.value) return true
      const workloadData = workloadSelectionRef.value.getSelections()
      const isWorkloadEmpty = !workloadData.selectedWorkload || workloadData.selectedWorkload === ''
      const isNumberOfExecutionsEmpty = !workloadData.numberOfExecutions || workloadData.numberOfExecutions <= 0
      return isWorkloadEmpty || isNumberOfExecutionsEmpty
    }

    return false
  } catch (error) {
    console.warn('Erreur lors de la vérification de la validation du formulaire:', error)
    return true // Retourner true pour maintenir le formulaire désactivé en cas d'erreur
  }
})

/**
 * Manages the form submission for the benchmark.
 * It collects the necessary data based on the selected benchmark type,
 * executes the benchmark, and handles the results or errors.
 * @param event The form submission event.
 * @returns {Promise<void>}
 */
const handleSubmit = async (event) => {
  event.preventDefault()

  // Réinitialiser les états précédents
  benchmarkResults.value = null
  isLoading.value = true
  apiError.value = null

  try {
    const result = await executeBenchmark()
    benchmarkResults.value = result
    emit('results-ready', result)
  } catch (error) {
    console.error('Erreur de benchmark:', error)
    apiError.value = error.message || 'Une erreur s\'est produite lors de l\'exécution du benchmark'
  } finally {
    isLoading.value = false
  }
}

/**
 * Collects the form data based on the current benchmark type.
 * @returns {Object} An object containing the endpoint and payload for the benchmark request.
 */
const collectFormData = () => {
  switch(currentBenchType.value) {
    case 'UNIQUE': {
      const queryData = querySelectionRef.value?.getSelections() || {}
      const dbData = dbSelectionRef.value?.getSelections() || {}
      const sizeData = dbSizeSelectionRef.value?.getSelections() || {}
      return {
        endpoint: ENDPOINTS.UNIQUE,
        payload: { ...queryData, ...dbData, ...sizeData }
      }
    }
    case 'WORKLOAD': {
      const workloadData = workloadSelectionRef.value?.getSelections() || {}
      const dbData = dbSelectionRef.value?.getSelections() || {}
      const sizeData = dbSizeSelectionRef.value?.getSelections() || {}
      return {
        endpoint: ENDPOINTS.WORKLOAD,
        payload: { ...workloadData, ...dbData, ...sizeData }
      }
    }
    case 'CONFIG': {
      const configData = configSelectionRef.value?.getSelections() || {}
      return {
        endpoint: configData.endpoint,
        payload: configData.config
      }
    }
    default:
      throw new Error('Type de benchmark inconnu')
  }
}

/**
 * Executes the benchmark by sending the collected data to the backend.
 * @returns {Promise<{message: string}|any|null>}
 */
const executeBenchmark = async () => {
  const { endpoint, payload } = collectFormData()

  console.log(`Sending request ${currentBenchType.value} to ${endpoint}:`, payload)

  const response = await fetch(`${API_BASE_URL}${endpoint}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  })

  if (!response.ok) {
    throw new Error(`Error ${response.status}: ${response.statusText}`)
  }

  // Check if the response is empty before parsing
  const responseText = await response.text()
  if (!responseText) return null

  try {
    return JSON.parse(responseText)
  } catch (parseError) {
    console.warn('Warning: The response is not JSON:', parseError)
    return { message: responseText }
  }
}

/**
 * Computed property to check if there are results from the benchmark.
 * @type {ComputedRef<boolean>}
 */
const hasResults = computed(() => {
  return benchmarkResults.value !== null
})
</script>

<template>
  <div class="content-container">
    <div class="header">
      <h1>Benchmark Tool</h1>
      <img src="/src/assets/logo_test-remove.png" alt="Benchmark Tool Logo" class="logo"/>
    </div>

    <BenchTypeButton ref="benchTypeButtonRef"/>

    <form @submit="handleSubmit">
      <QuerySelection v-if="currentBenchType === 'UNIQUE'" ref="querySelectionRef"/>
      <WorkloadSelection v-if="currentBenchType === 'WORKLOAD'" ref="workloadSelectionRef"/>
      <ConfigSelection v-if="currentBenchType === 'CONFIG'" ref="configSelectionRef"/>

      <template v-if="currentBenchType !== 'CONFIG'">
        <DbSelection ref="dbSelectionRef"/>
        <DbSizeSelection ref="dbSizeSelectionRef"/>
      </template>

      <!-- Message d'erreur -->
      <div v-if="apiError" class="error">
        <p>{{ apiError }}</p>
      </div>

      <div class="submit-container">
        <button
            type="submit"
            class="btn btn-large"
            :disabled="hasEmptyFields || isLoading"
        >
          <span v-if="isLoading">⏳ Running Benchmark...</span>
          <span v-else>Start Benchmark</span>
        </button>
      </div>
    </form>
  </div>
</template>

<style>
.header {
  display: flex;
  align-items: baseline;
  margin-bottom: 24px;
}

.logo {
  width: auto;
  height: 2.5rem;
  margin-left: 16px;
}

.submit-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin: 40px auto;
  max-width: 600px;
}

.report-section {
  margin-top: 40px;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}
</style>